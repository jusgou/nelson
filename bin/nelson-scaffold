#!/bin/bash
# Nelson Scaffold - Set up Nelson Loop framework in a project
# Usage: nelson-scaffold [nelson|snarktank|plan-build|all] [target_directory]
#
# Workflows:
#   nelson      - Integrated build + review (RECOMMENDED)
#   snarktank   - Legacy: build only
#   plan-build  - Legacy: spec-based two-phase
#   all         - All workflows

set -e

TEMPLATES_DIR="$HOME/.nelson"
MODE="${1:-nelson}"
TARGET_DIR="${2:-.}"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_header() {
    echo -e "${BLUE}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║${NC}  Nelson Scaffold - Initialize Nelson Loop Framework     ${BLUE}║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_info() {
    echo -e "${BLUE}→${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}!${NC} $1"
}

# ============================================================
# NELSON - Integrated Build + Review (Primary workflow)
# ============================================================
scaffold_nelson() {
    local target="$1"
    local nelson_dir="$target/.nelson"

    print_info "Setting up Nelson workflow (integrated build + review)..."

    mkdir -p "$nelson_dir"
    mkdir -p "$nelson_dir/nelson-logs"
    mkdir -p "$nelson_dir/completions"

    # Copy templates
    cp "$TEMPLATES_DIR/workflows/nelson/loop.sh" "$nelson_dir/"
    cp "$TEMPLATES_DIR/workflows/nelson/CLAUDE.md" "$nelson_dir/"

    chmod +x "$nelson_dir/loop.sh"

    # Create prd.json if not exists
    if [ ! -f "$nelson_dir/prd.json" ]; then
        print_info "Creating initial prd.json..."
        cat > "$nelson_dir/prd.json" <<'EOF'
{
  "project": "PROJECT_NAME",
  "branchName": "nelson/initial",
  "description": "Initial Nelson setup",
  "userStories": [
    {
      "id": "US-001",
      "title": "Setup complete",
      "description": "As a developer, I want to verify Nelson is configured correctly.",
      "acceptanceCriteria": [
        ".nelson/loop.sh is executable",
        ".nelson/CLAUDE.md exists",
        ".nelson/prd.json is valid JSON"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    }
  ]
}
EOF
    else
        print_warning "prd.json already exists, keeping existing file"
    fi

    # Create progress file
    if [ ! -f "$nelson_dir/progress.txt" ]; then
        cat > "$nelson_dir/progress.txt" <<EOF
# Nelson Progress Log
Started: $(date)
Workflow: Nelson (integrated build + review)
---
EOF
    fi

    print_success "Nelson workflow configured"
    print_info "Files created in .nelson/:"
    echo "  - loop.sh (integrated build + review loop)"
    echo "  - CLAUDE.md (agent instructions)"
    echo "  - prd.json (user stories)"
    echo "  - progress.txt (learnings log)"
    echo "  - nelson-logs/ (progress logs)"
    echo "  - completions/ (PRD completion docs)"
}

# ============================================================
# SNARKTANK - Legacy build-only workflow
# ============================================================
scaffold_snarktank() {
    local target="$1"
    local nelson_dir="$target/.nelson"

    print_info "Setting up Snarktank workflow (legacy: build only)..."

    mkdir -p "$nelson_dir"

    cp "$TEMPLATES_DIR/workflows/snarktank/loop.sh" "$nelson_dir/snarktank-loop.sh"
    cp "$TEMPLATES_DIR/workflows/snarktank/CLAUDE.md" "$nelson_dir/SNARKTANK_CLAUDE.md"
    cp "$TEMPLATES_DIR/workflows/snarktank/prd.json.example" "$nelson_dir/"

    chmod +x "$nelson_dir/snarktank-loop.sh"

    if [ ! -f "$nelson_dir/prd.json" ]; then
        print_info "Creating initial prd.json..."
        cat > "$nelson_dir/prd.json" <<'EOF'
{
  "project": "PROJECT_NAME",
  "branchName": "nelson/initial",
  "description": "Initial setup",
  "userStories": [
    {
      "id": "US-001",
      "title": "Setup complete",
      "description": "Verify configuration.",
      "acceptanceCriteria": [".nelson/prd.json is valid"],
      "priority": 1,
      "passes": false,
      "notes": ""
    }
  ]
}
EOF
    fi

    if [ ! -f "$nelson_dir/progress.txt" ]; then
        echo "# Snarktank Progress Log" > "$nelson_dir/progress.txt"
        echo "Started: $(date)" >> "$nelson_dir/progress.txt"
        echo "---" >> "$nelson_dir/progress.txt"
    fi

    print_success "Snarktank workflow configured"
    print_info "Files in .nelson/:"
    echo "  - snarktank-loop.sh"
    echo "  - SNARKTANK_CLAUDE.md"
}

# ============================================================
# PLAN-BUILD - Legacy spec-based workflow
# ============================================================
scaffold_plan_build() {
    local target="$1"
    local nelson_dir="$target/.nelson"

    print_info "Setting up Plan/Build workflow (legacy: spec-based)..."

    mkdir -p "$nelson_dir"

    cp "$TEMPLATES_DIR/workflows/plan-build/loop.sh" "$nelson_dir/plan-build-loop.sh"
    cp "$TEMPLATES_DIR/workflows/plan-build/PROMPT_plan.md" "$nelson_dir/"
    cp "$TEMPLATES_DIR/workflows/plan-build/PROMPT_build.md" "$nelson_dir/"

    chmod +x "$nelson_dir/plan-build-loop.sh"

    if [ ! -f "$nelson_dir/@IMPLEMENTATION_PLAN.md" ]; then
        print_info "Creating @IMPLEMENTATION_PLAN.md..."
        cat > "$nelson_dir/@IMPLEMENTATION_PLAN.md" <<'EOF'
# Implementation Plan

## High Priority
- [ ] Initialize project structure

## Medium Priority
- [ ] Add core functionality

## Completed
- [x] Nelson framework scaffolded
EOF
    fi

    print_success "Plan/Build workflow configured"
    print_info "Files in .nelson/:"
    echo "  - plan-build-loop.sh"
    echo "  - PROMPT_plan.md"
    echo "  - PROMPT_build.md"
}

# ============================================================
# SHARED
# ============================================================
scaffold_agents_md() {
    local target="$1"
    local nelson_dir="$target/.nelson"

    mkdir -p "$nelson_dir"

    if [ ! -f "$nelson_dir/AGENTS.md" ]; then
        print_info "Creating AGENTS.md..."
        cp "$TEMPLATES_DIR/shared/AGENTS.md" "$nelson_dir/"
        print_success "AGENTS.md created"
    else
        print_warning "AGENTS.md already exists, skipping"
    fi
}

create_gitignore_entries() {
    local target="$1"
    local gitignore="$target/.gitignore"

    if [ -f "$gitignore" ]; then
        if ! grep -q "# Nelson" "$gitignore"; then
            print_info "Adding Nelson entries to .gitignore..."
            cat >> "$gitignore" <<'EOF'

# Nelson
.nelson/progress.txt
.nelson/archive/
.nelson/completions/
.nelson/nelson-logs/
.nelson/.locks/
.nelson/.last-branch
.nelson/.last-review-count
EOF
            print_success ".gitignore updated"
        fi
    else
        print_info "Creating .gitignore..."
        cat > "$gitignore" <<'EOF'
# Nelson
.nelson/progress.txt
.nelson/archive/
.nelson/completions/
.nelson/nelson-logs/
.nelson/.locks/
.nelson/.last-branch
.nelson/.last-review-count
EOF
        print_success ".gitignore created"
    fi
}

# ============================================================
# MAIN
# ============================================================
print_header

if [ ! -d "$TARGET_DIR" ]; then
    echo "Error: Target directory '$TARGET_DIR' does not exist"
    exit 1
fi

cd "$TARGET_DIR"
TARGET_DIR=$(pwd)

print_info "Target: $TARGET_DIR"
print_info "Workflow: $MODE"
echo ""

case "$MODE" in
    nelson)
        scaffold_nelson "$TARGET_DIR"
        scaffold_agents_md "$TARGET_DIR"
        create_gitignore_entries "$TARGET_DIR"
        ;;
    snarktank)
        scaffold_snarktank "$TARGET_DIR"
        scaffold_agents_md "$TARGET_DIR"
        create_gitignore_entries "$TARGET_DIR"
        ;;
    plan-build)
        scaffold_plan_build "$TARGET_DIR"
        scaffold_agents_md "$TARGET_DIR"
        create_gitignore_entries "$TARGET_DIR"
        ;;
    all)
        scaffold_nelson "$TARGET_DIR"
        scaffold_snarktank "$TARGET_DIR"
        scaffold_plan_build "$TARGET_DIR"
        scaffold_agents_md "$TARGET_DIR"
        create_gitignore_entries "$TARGET_DIR"
        ;;
    *)
        echo "Error: Invalid mode '$MODE'"
        echo "Use: nelson, snarktank, plan-build, or all"
        exit 1
        ;;
esac

echo ""
print_success "Nelson framework scaffolded!"
echo ""
print_info "Next steps:"

if [ "$MODE" = "nelson" ] || [ "$MODE" = "all" ]; then
    echo ""
    echo "  Nelson workflow (recommended):"
    echo "    1. Generate PRD: nelson-prd-generator"
    echo "    2. Update .nelson/AGENTS.md with project info"
    echo "    3. Run: .nelson/loop.sh --start-review 1 --review-every 1 20"
    echo "    4. Monitor: nelson-status --watch"
fi

if [ "$MODE" = "snarktank" ]; then
    echo ""
    echo "  Snarktank workflow (legacy):"
    echo "    1. Generate PRD: nelson-prd-generator"
    echo "    2. Run: .nelson/snarktank-loop.sh --tool claude 15"
fi

if [ "$MODE" = "plan-build" ] || [ "$MODE" = "all" ]; then
    echo ""
    echo "  Plan/Build workflow (legacy):"
    echo "    1. Generate specs: nelson-specs-generator"
    echo "    2. Run planning: .nelson/plan-build-loop.sh plan"
    echo "    3. Run building: .nelson/plan-build-loop.sh 20"
fi

echo ""
