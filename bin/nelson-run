#!/bin/bash
# Nelson Run - Interactive runner for Nelson Loop Framework
# Usage: nelson-run [max_iterations]

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m'

NELSON_DIR=".nelson"
CONFIG_FILE="$NELSON_DIR/config.json"
DEFAULT_ITERATIONS=20

print_header() {
    echo ""
    echo -e "${BLUE}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║${NC}  ${BOLD}Nelson Run${NC}                                                 ${BLUE}║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_info() {
    echo -e "${BLUE}→${NC} $1"
}

print_warn() {
    echo -e "${YELLOW}!${NC} $1"
}

# Prompt with options - sets REPLY to the number selected
prompt_choice() {
    local prompt="$1"
    shift
    local options=("$@")

    echo ""
    echo -e "${BOLD}$prompt${NC}"
    echo ""

    local i=1
    for opt in "${options[@]}"; do
        echo "  [$i] $opt"
        ((i++))
    done
    echo ""

    while true; do
        read -p "> " REPLY
        if [[ "$REPLY" =~ ^[0-9]+$ ]] && [ "$REPLY" -ge 1 ] && [ "$REPLY" -le "${#options[@]}" ]; then
            return 0
        fi
        echo "Please enter a number between 1 and ${#options[@]}"
    done
}

# Check if PRD is locked
is_locked() {
    local prd="$1"
    local lock_file="$NELSON_DIR/.locks/${prd}.lock"

    if [ ! -f "$lock_file" ]; then
        return 1  # Not locked
    fi

    # Check if lock is stale (process no longer running)
    local lock_pid=$(cat "$lock_file" 2>/dev/null)
    if [ -n "$lock_pid" ] && ! kill -0 "$lock_pid" 2>/dev/null; then
        rm -f "$lock_file"
        return 1  # Lock was stale, removed
    fi

    return 0  # Locked
}

# Check if PRD is complete
is_complete() {
    local prd="$NELSON_DIR/$1"
    if [ ! -f "$prd" ]; then
        return 1
    fi
    local incomplete=$(jq '[.userStories[] | select(.passes == false)] | length' "$prd" 2>/dev/null)
    [ -n "$incomplete" ] && [ "$incomplete" -eq 0 ]
}

# Get list of PRDs
get_prds() {
    local prds=()
    if [ -f "$NELSON_DIR/prd.json" ]; then
        prds+=("prd.json")
    fi
    local num=2
    while [ -f "$NELSON_DIR/prd-${num}.json" ]; do
        prds+=("prd-${num}.json")
        ((num++))
    done
    echo "${prds[@]}"
}

# Find first available (unlocked, incomplete) PRD
find_available_prd() {
    local locking="$1"
    local prds=($(get_prds))

    for prd in "${prds[@]}"; do
        if is_complete "$prd"; then
            continue  # Skip complete PRDs
        fi
        if [ "$locking" = "true" ] && is_locked "$prd"; then
            continue  # Skip locked PRDs
        fi
        echo "$prd"
        return 0
    done

    return 1  # No available PRD
}

# Get PRD status description
get_prd_status() {
    local prd="$1"
    local locking="$2"

    local status=""

    if is_complete "$prd"; then
        status="complete"
    elif [ "$locking" = "true" ] && is_locked "$prd"; then
        status="in use"
    else
        local total=$(jq '.userStories | length' "$NELSON_DIR/$prd" 2>/dev/null || echo "0")
        local done=$(jq '[.userStories[] | select(.passes == true)] | length' "$NELSON_DIR/$prd" 2>/dev/null || echo "0")
        status="$done/$total"
    fi

    echo "$status"
}

# Read config value
config_get() {
    local key="$1"
    local default="$2"
    local value=$(jq -r ".$key // \"$default\"" "$CONFIG_FILE" 2>/dev/null)
    echo "$value"
}

# Describe mode for display
describe_mode() {
    local mode="$1"
    local freq="$2"

    if [ "$mode" = "quick" ]; then
        echo "Classic Ralph (no reviews)"
    else
        if [ "$freq" -eq 1 ]; then
            echo "Full Nelson (reviews after every story)"
        else
            echo "Full Nelson (reviews every $freq stories)"
        fi
    fi
}

# Main
main() {
    local max_iterations="${1:-$DEFAULT_ITERATIONS}"

    print_header

    # Check for .nelson directory
    if [ ! -d "$NELSON_DIR" ]; then
        echo -e "${YELLOW}Nelson hasn't been set up for this project yet.${NC}"
        echo ""
        read -p "Run nelson-init to set up? (Y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Nn]$ ]]; then
            if command -v nelson-init &> /dev/null; then
                exec nelson-init
            else
                exec ~/.nelson/bin/nelson-init
            fi
        fi
        exit 0
    fi

    # Check for config
    if [ ! -f "$CONFIG_FILE" ]; then
        echo -e "${YELLOW}Config file missing. Running nelson-init...${NC}"
        if command -v nelson-init &> /dev/null; then
            exec nelson-init
        else
            exec ~/.nelson/bin/nelson-init
        fi
    fi

    # Check for loop.sh
    if [ ! -f "$NELSON_DIR/loop.sh" ]; then
        echo -e "${RED}Error: loop.sh not found in .nelson/${NC}"
        echo "Try running: nelson-init"
        exit 1
    fi

    # Read config
    local PROJECT=$(config_get "project" "unknown")
    local MODE=$(config_get "mode" "full")
    local FREQUENCY=$(config_get "reviewFrequency" "2")
    local LOCKING=$(config_get "locking" "true")

    print_info "Project: $PROJECT"
    print_info "Mode: $(describe_mode "$MODE" "$FREQUENCY")"
    echo ""

    # Model selection
    prompt_choice "Which Claude model should Nelson use?" \
        "Sonnet 4.5 (fast, cost-effective)" \
        "Opus 4.5 (strongest reasoning)" \
        "Sonnet 4 (balanced)" \
        "Haiku 3.5 (fastest, cheapest)"
    local model_choice=$REPLY

    local SELECTED_MODEL=""
    case $model_choice in
        1) SELECTED_MODEL="sonnet" ;;
        2) SELECTED_MODEL="opus" ;;
        3) SELECTED_MODEL="claude-sonnet-4-20250514" ;;
        4) SELECTED_MODEL="haiku" ;;
    esac

    print_success "Model: $SELECTED_MODEL"
    echo ""

    # Review frequency override
    if [ "$MODE" = "full" ]; then
        prompt_choice "How many stories before a review phase?" \
            "After every story (maximum rigor)" \
            "Every 2 stories" \
            "Every 3 stories" \
            "Every 4 stories" \
            "Every 5 stories"
        FREQUENCY=$REPLY
        print_success "Review frequency: every $FREQUENCY story(ies)"
        echo ""
    fi

    # Find available PRD
    local TARGET_PRD
    TARGET_PRD=$(find_available_prd "$LOCKING")

    if [ -z "$TARGET_PRD" ]; then
        # No available PRD - figure out why
        local prds=($(get_prds))

        if [ ${#prds[@]} -eq 0 ]; then
            echo -e "${YELLOW}No PRD files found.${NC}"
            echo ""
            read -p "Create one now? (Y/n) " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Nn]$ ]]; then
                if command -v nelson-init &> /dev/null; then
                    exec nelson-init
                else
                    exec ~/.nelson/bin/nelson-init
                fi
            fi
            exit 0
        fi

        # Check if all complete or all locked
        local all_complete=true
        local all_locked=true

        for prd in "${prds[@]}"; do
            if ! is_complete "$prd"; then
                all_complete=false
            fi
            if [ "$LOCKING" != "true" ] || ! is_locked "$prd"; then
                all_locked=false
            fi
        done

        if [ "$all_complete" = true ]; then
            print_success "All PRDs complete!"
            echo ""
            prompt_choice "What would you like to do?" \
                "Create another PRD" \
                "Exit"
            local choice=$REPLY

            if [ $choice -eq 1 ]; then
                if command -v nelson-init &> /dev/null; then
                    exec nelson-init
                else
                    exec ~/.nelson/bin/nelson-init
                fi
            fi
            exit 0
        fi

        if [ "$all_locked" = true ]; then
            echo -e "${YELLOW}All incomplete PRDs are currently in use by other instances.${NC}"
            echo ""
            echo "PRD status:"
            for prd in "${prds[@]}"; do
                echo "  $prd: $(get_prd_status "$prd" "$LOCKING")"
            done
            echo ""

            prompt_choice "What would you like to do?" \
                "Create another PRD" \
                "Wait for a PRD to become available" \
                "Exit"
            local choice=$REPLY

            case $choice in
                1)
                    if command -v nelson-init &> /dev/null; then
                        exec nelson-init
                    else
                        exec ~/.nelson/bin/nelson-init
                    fi
                    ;;
                2)
                    echo ""
                    print_info "Waiting for a PRD to become available..."
                    while true; do
                        sleep 5
                        TARGET_PRD=$(find_available_prd "$LOCKING")
                        if [ -n "$TARGET_PRD" ]; then
                            print_success "Found available PRD: $TARGET_PRD"
                            break
                        fi
                    done
                    ;;
                3)
                    exit 0
                    ;;
            esac
        fi
    fi

    # We have a target PRD
    if [ -n "$TARGET_PRD" ]; then
        local status=$(get_prd_status "$TARGET_PRD" "$LOCKING")
        print_info "Target: $TARGET_PRD ($status)"
        echo ""
        print_info "Starting Nelson..."
        print_info "Model: $SELECTED_MODEL"
        print_info "Mode: $(describe_mode "$MODE" "$FREQUENCY")"
        print_info "Max iterations: $max_iterations"
        echo ""

        # Build command
        local CMD="$NELSON_DIR/loop.sh"

        if [ -n "$SELECTED_MODEL" ]; then
            CMD="$CMD --model $SELECTED_MODEL"
        fi

        if [ "$MODE" = "full" ]; then
            CMD="$CMD --start-review 1 --review-every $FREQUENCY"
        fi

        CMD="$CMD --prd $TARGET_PRD"

        if [ "$LOCKING" != "true" ]; then
            CMD="$CMD --no-lock"
        fi

        CMD="$CMD $max_iterations"

        # Run it
        exec $CMD
    fi
}

main "$@"
